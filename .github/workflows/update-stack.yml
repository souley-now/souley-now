name: Update Tech Stack Section

on:
  schedule:
    - cron: "0 3 * * *"   # once per day
  workflow_dispatch:

jobs:
  update-stack:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get languages via GitHub API
        id: langs
        uses: actions/github-script@v7
        with:
          script: |
            const res = await github.request("GET /users/${{ github.repository_owner }}/repos", {
              per_page: 100,
              sort: "updated"
            });

            const repos = res.data.filter(r => !r.fork);
            const langCounts = {};

            for (const repo of repos) {
              const langsRes = await github.request(repo.languages_url);
              const langs = langsRes.data;
              for (const [lang, bytes] of Object.entries(langs)) {
                langCounts[lang] = (langCounts[lang] || 0) + bytes;
              }
            }

            const sorted = Object.entries(langCounts)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 6)
              .map(([lang]) => lang);

            core.setOutput("langs", sorted.join(","));

      - name: Update README stack section
        run: |
          langs="${{ steps.langs.outputs.langs }}"
          IFS=',' read -ra arr <<< "$langs"

          BADGES=""
          for l in "${arr[@]}"; do
            # create a shields.io badge per language
            trimmed="$(echo "$l" | xargs)"
            BADGES+=$(printf '<img src="https://img.shields.io/badge/%s-000000?style=for-the-badge" alt="%s" /> ' "$trimmed" "$trimmed")
          done

          # replace between STACK_START and STACK_END
          perl -0pi -e "s/<!-- STACK_START -->[\\s\\S]*?<!-- STACK_END -->/<!-- STACK_START -->\n$BADGES\n<!-- STACK_END -->/g" README.md

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update tech stack from repos"
          file_pattern: README.md
